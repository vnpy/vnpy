# AlgoTrading - 算法交易模块


## 功能简介

AlgoTrading是用于**执行算法交易**的功能模块，用户可以通过图形界面操作来便捷完成启动算法、保存配置、停止算法等任务。

算法交易负责委托订单的具体执行过程。目前，AlgoTrading提供了多种示例算法，用户可以通过把大笔订单自动拆分成合适的小单分批委托，有效降低交易成本和冲击成本（如冰山算法、狙击手算法），也可以在设定的阈值内进行高抛低吸操作（如网格算法、套利算法）。


## 加载启动

### VN Station加载

启动登录VN Station后，点击【VN Trader Pro】按钮，在配置对话框中的【上层应用】栏勾选【AlgoTrading】。

### 脚本加载

在启动脚本中添加如下代码：

```
# 写在顶部
from vnpy.app.algo_trading import AlgoTradingApp

# 写在创建main_engine对象后
main_engine.add_app(AlgoTradingApp)
```  


## 启动模块

启动VN Trader后，在菜单栏中点击【功能】-> 【算法交易】，或者点击左侧按钮栏的图标：

![](https://vnpy-doc.oss-cn-shanghai.aliyuncs.com/algo_trading/1.png)

即可进入算法交易模块的UI界面，如下图所示：

![](https://vnpy-doc.oss-cn-shanghai.aliyuncs.com/algo_trading/2.png)

该界面由委托交易、数据监控两部分组成：

- 委托交易：位于界面左侧，用于启动或停止算法交易、保存配置信息等操作；
- 数据监控：位于界面右侧，用于监控算法交易执行情况，并且能够手动停止算法交易。


## 启动算法

目前vn.py共提供了8种常用的示例算法，同时也对接了金纳科技提供的交易算法。本文档以时间加权平均算法（TWAP）为例，介绍算法启动过程。

在启动算法时，需要配置相关参数，如下图所示：

![](https://vnpy-doc.oss-cn-shanghai.aliyuncs.com/algo_trading/3.png)

各参数要求如下：

- 算法：在下拉框中选择要执行的交易算法；
- 本地代码：格式为vt_symbol（合约代码 + 交易所名称）；
- 方向：做多或者做空；
- 价格：委托下单的价格；
- 数量：委托的总数量，需要拆分成小批订单进行交易；
- 执行时间：运行该算法交易的总时间，以秒为单位；
- 每轮间隔：每隔多少时间进行委托下单操作，以秒为单位。

参数配置完成后，点击【启动算法】按钮，即可立刻执行算法交易。

图中执行的任务具体为：使用时间加权平均算法，买入10000手豆油2109合约（y2109），执行价格为9000元，执行时间为600秒，每轮间隔为6秒；即每隔6秒钟，当合约买一价少于等于9000时，以9000的价格买入100手豆油2109合约，将买入操作分割成100次。


## 保存配置

交易算法的配置信息可以用json文件保存在本地，这样每次打开算法交易模块无需重复输入，具体操作如下：

- 在【配置名称】选项中输入该算法配置信息的命名，然后点击下方【保存配置】按钮，即可保存配置信息到本地；
- 保存配置后，在界面右侧的配置组件可以看到用户保存的配置名称和配置参数。

![](https://vnpy-doc.oss-cn-shanghai.aliyuncs.com/algo_trading/4.png)

保存的配置文件在C:\Users\Administrator\\.vntrader文件夹的algo_trading_setting.json中，如下图所示：

![](https://vnpy-doc.oss-cn-shanghai.aliyuncs.com/algo_trading/5.png)


## 停止算法

当用户需要停止正在执行的交易算法时，可以在数据监控界面点击【停止】按钮，停止某个正在执行的算法交易，如下图所示：

![](https://vnpy-doc.oss-cn-shanghai.aliyuncs.com/algo_trading/6.png)

用户也可以在委托交易界面点击最下方的【全部停止】按钮，一键停止所有执行中的算法交易。


## 数据监控

数据监控界面由4个部分构成：

活动组件显示正在执行的算法交易，包括：算法名称、参数和状态，如下图所示：

![](https://vnpy-doc.oss-cn-shanghai.aliyuncs.com/algo_trading/6.png)

历史委托组件显示已完成的算法交易，同样包括：算法名称、参数和状态，如下图所示：

![](https://vnpy-doc.oss-cn-shanghai.aliyuncs.com/algo_trading/9.png)

日志组件显示启动、停止、完成算法的相关日志信息。在打开算法交易模块后，会进行初始化，故日志组件会首先显示“算法交易引擎启动”和“算法配置载入成功”，如下图所示：

![](https://vnpy-community.oss-cn-shanghai.aliyuncs.com/forum_experience/yazhang/algo_trader/log_section.png)

配置组件：用于载入algo_trading_setting.json的配置信息，并以图形化界面显示出来，如下图所示：

![](https://vnpy-doc.oss-cn-shanghai.aliyuncs.com/algo_trading/8.png)

- 点击配置组件的【使用】按钮立刻读取该配置信息，并显示在委托交易界面上，随后点击【启动算法】即可开始进行交易；

- 点击配置组件【移除】按钮可以移除该算法配置，并同步更新到json文件内。


## 示例算法

示例算法路径位于vnpy/app/algo_trading/algos文件夹下。目前，算法交易模块提供了以下8种内置算法：

**TWAP - 时间加权平均算法**

时间加权平均算法（TWAP）每隔一段时间用指定价格挂出买单或卖单，将委托数量平均分布在一段时间区域内，具体执行步骤如下：

- 买入情况：买一价低于目标价格时，发出委托，委托数量在剩余委托量与委托分割量中取最小值；

- 卖出情况：卖一价高于目标价格时，发出委托，委托数量在剩余委托量与委托分割量中取最小值。

**Sniper - 狙击手算法**

狙击手算法（Sniper）通过监控最新推送的Tick行情，发现好的价格立刻报价成交，具体执行步骤如下：

- 买入情况：最新Tick卖一价低于目标价格时，发出委托，委托数量在剩余委托量与卖一量中取最小值；

- 卖出情况：最新Tick买一价高于目标价格时，发出委托，委托数量在剩余委托量与买一量中取最小值。

**Iceberg - 冰山算法**

冰山算法（Iceberg）在某个价位挂单，但是只挂一部分，直到全部成交，具体执行步骤如下：

- 买入情况：先检查撤单，最新Tick卖一价低于目标价格时执行撤单；若无活动委托，发出委托，委托数量在剩余委托量与挂出委托量中取最小值；

- 卖出情况：先检查撤单，最新Tick买一价高于目标价格执行撤单；若无活动委托，发出委托，委托数量在剩余委托量与挂出委托量中取最小值。

**BestLimit - 最优限价算法**

最优限价算法（BsetLimit）监控Tick推送的最新行情，发现好的价格立刻报价成交，具体执行步骤如下：

- 买入情况：先检查撤单，最新Tick买一价不等于目标价格时执行撤单；若无活动委托，发出委托，委托价格为最新Tick买一价，委托数量为剩余委托量；

- 卖出情况：先检查撤单，最新Tick买一价不等于目标价格时执行撤单；若无活动委托，发出委托，委托价格为最新Tick卖一价，委托数量为剩余委托量。

**Stop - 条件委托算法**

条件委托算法（StopAlgo）监控最新tick推送的行情，发现行情突破立刻报价成交，具体执行步骤如下：

- 买入情况：Tick最新价高于目标价格时，发出委托，委托价为目标价格加上超价；

- 卖出情况：Tick最新价低于目标价格时，发出委托，委托价为目标价格减去超价。

**DMA - 直接委托算法**

直接委托算法（DMA）直接发出新的委托（限价单、停止单、市价单）。

**Arbitrage - 套利算法**

套利算法（Arbitrage）每隔一段时间检查委托情况，若有委托则先清空；若主动腿还持有净持仓，通过被动腿成交来对冲，具体执行步骤如下：

- 计算价差spread_bid_price 和 spread_ask_price，以及对应的委托数量；

- 卖出情况：主动腿价格相对被动腿上涨，其价差spread_bid_price大于spread_up时，触发买入信号；

- 买入情况：主动腿价格相对被动腿下跌，其价差spread_ask_price小于 - spread_down（spread_down默认设置为正数）时，触发卖出信号；

- 在买卖信号判断加入最大持仓的限制，其作用是避免持仓过多导致保证金不足或者直接被交易所惩罚性强平；而且随着价差持续波动，主动腿持仓可以从0 -> 10 -> 0 -> -10 -> 0，从而实现平仓获利离场。

**Grid - 网格交易算法**

网格交易算法每隔一段时间检查委托情况，若有委托则先清空，具体执行步骤如下：

- 基于用户设置的价格步进（即网格）计算目标距离，目标距离=（目标价格 - 当前价格）/ 价格步进，故当前价格低于目标价格，目标距离为正，方向为买入；当前价格高于目标价格，目标距离为负，方向为卖出（高抛低吸概念）；

- 计算目标仓位，目标仓位 = 取整后的目标距离 * 委托数量步进。注意买卖方向取整的方式是不同的：买入方向要向下取整math.floor()，如目标距离为1.6，取1；卖出方向要向上取整，如目标距离为-1.6，取-1；

- 计算具体委托仓位：若目标买入仓位大于当前仓位，执行买入操作；若目标卖出仓位低于当前仓位，执行卖出操作；

- 为了能够快速成交，买入情况是基于ask price计算，卖出情况是基于bid price计算。


## 金纳算法

除了8种内置算法外，算法交易模块也对接了[金纳科技](http://www.genus-finance.com/)提供的算法，包括直接委托算法（DMA）、时间加权均价算法（TWAP）、成交量加权均价算法（VWAP）、交易量百分比算法（Percent）、价格跟踪算法（PxInLine）和盘口捕捉算法（Sniper）。

与内置算法相比，金纳算法通过结合全息盘口和L2行情数据来优化算法中的买卖执行细节，从而进一步降低交易成本，也可以理解为在金纳算法中嵌入了一部分高频量化策略的信号来优化买卖点。

用户可以自行联系金纳科技购买账号，也可以联系券商是否采购（如中泰、申万宏源）来申请免费账号。获得金纳的账户信息后，只需在VN Trader主界面的菜单栏中点击【配置】按钮进行配置，即可使用金纳算法。具体配置过程详见基本使用文档的全局配置部分。